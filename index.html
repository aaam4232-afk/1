<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#004d40">

    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { --primary: #004d40; --orange: #ff6d00; --bg: #f4f7f6; --white: #ffffff; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); margin: 0; padding: 0; color: #333; overflow-x: hidden; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-7px); }
            50% { transform: translateX(7px); }
            75% { transform: translateX(-7px); }
        }
        .error-shake { animation: shake 0.4s ease-in-out; border: 2.5px solid #e74c3c !important; }

        .header { background: linear-gradient(135deg, var(--primary), #00796b); color: white; padding: 35px 20px 55px; text-align: center; border-radius: 0 0 30px 30px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        .header h1 { margin: 0; font-size: 1.8rem; font-weight: 900; }
        .refresh-btn { position: absolute; top: 5px; right: 15px; background: #ffffff; border: none; color: var(--primary); padding: 8px 15px; border-radius: 10px; font-size: 0.8rem; cursor: pointer; font-family: 'Tajawal'; font-weight: 800; box-shadow: 0 4px 10px rgba(0,0,0,0.15); z-index: 1000; }
        
        .main-content { padding: 0 15px; margin-top: -30px; position: relative; z-index: 10; }
        .section-card { background: var(--white); border-radius: 20px; padding: 18px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 20px; }
        
        .winner-box-fixed { background: #fff9c4; padding: 10px; border-radius: 15px; margin-bottom: 15px; border: 2px solid #f1c40f; text-align: center; font-weight: 800; color: #d35400; font-size: 1rem; display: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); }

        #statusToast { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); padding: 16px 35px; border-radius: 50px; color: white; font-weight: 800; z-index: 10000; transition: 0.5s; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        .grid-small { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .offer-box { background: #fff; border: 1px solid #eee; border-radius: 18px; padding: 18px; text-align: center; cursor: pointer; transition: 0.2s; }
        .offer-box:active { transform: scale(0.95); }
        
        .status-tag { font-size: 0.7rem; font-weight: 800; padding: 3px 10px; border-radius: 8px; margin-top: 5px; display: inline-block; }
        .has { color: #2e7d32; background: #e8f5e9; }
        .none { color: #9e9e9e; background: #f5f5f5; }

        .directory-list { display: flex; overflow-x: auto; gap: 10px; padding: 5px 0 15px; scrollbar-width: none; }
        .dir-pill { background: var(--primary); color: white; padding: 12px 22px; border-radius: 30px; font-size: 0.9rem; font-weight: 700; white-space: nowrap; cursor: pointer; border: none; }
        
        .merchant-btn-style { width: 100%; padding: 18px; border-radius: 18px; border: none; background: var(--primary); color: white; font-family: 'Tajawal'; font-weight: 800; cursor: pointer; margin-top: -15px; margin-bottom: 20px; }
        
        .full-page { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 5000; overflow-y: auto; }
        .top-nav { background: white; padding: 15px; display: flex; align-items: center; gap: 15px; position: sticky; top: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .back-btn { background: #f0f0f0; border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; }
        
        .m-input { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 14px; border: 1.5px solid #ddd; font-family: 'Tajawal'; font-size: 1rem; box-sizing: border-box; }
        .m-btn { width: 100%; padding: 18px; border-radius: 14px; border: none; background: var(--primary); color: white; font-weight: 800; font-size: 1.1rem; cursor: pointer; }
        .product-card { background: white; margin: 12px 15px; padding: 18px; border-radius: 20px; border-right: 6px solid #ddd; }
    </style>
</head>
<body>

    <audio id="waterSnd" preload="auto">
        <source src="https://www.soundjay.com/misc/sounds/water-droplet-1.mp3">
    </audio>

    <div id="statusToast"></div>

    <div class="header">
        <button class="refresh-btn" onclick="playWater(); location.reload()">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
        <h1>Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯ ğŸ›’</h1>
        <p>Ø¹Ø±ÙˆØ¶ Ø§Ù„Ù…Ø­Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø³Ø§Ø¨Ù‚Ø§Øª ÙÙŠ Ù…ÙƒØ§Ù† ÙˆØ§Ø­Ø¯</p>
    </div>

    <div class="main-content">
        <div id="winnerDiv" class="winner-box-fixed">ğŸ† Ø§Ù„ÙØ§Ø¦Ø²: <span id="wName"></span></div>

        <div class="section-card">
            <div class="title-label" style="font-weight: 800; margin-bottom: 10px;">ğŸ”¥ Ø¹Ø±ÙˆØ¶ ÙˆØªØ®ÙÙŠØ¶Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
            <div class="grid-small">
                <div class="offer-box" onclick="openGlobalOffers('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'ğŸ”')"><span>ğŸ”</span><br><b>Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</b><span id="st-Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§" class="status-tag none">...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'ğŸ')"><span>ğŸ</span><br><b>Ø§Ù„ØºØ°Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©" class="status-tag none">...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'ğŸ—ï¸')"><span>ğŸ—ï¸</span><br><b>Ø§Ù„Ø¨Ù†Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©" class="status-tag none">...</span></div>
                <div class="offer-box" onclick="openGlobalOffers('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡', 'âš¡')"><span>âš¡</span><br><b>Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</b><span id="st-Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡" class="status-tag none">...</span></div>
            </div>
        </div>

        <div class="section-card" style="background:transparent; box-shadow:none; padding:0;">
            <div class="title-label" style="font-weight: 800; margin-bottom: 10px;">ğŸ“‚ Ø¯Ù„ÙŠÙ„ Ù…Ø­Ù„Ø§Øª Ø¹Ø²Ø§Ù†</div>
            <div class="directory-list">
                <div class="dir-pill" onclick="openFullDirectory('Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§')">ğŸ˜ï¸ Ø§Ù„Ù…Ø·Ø§Ø¹Ù…</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©')">ğŸ± Ø§Ù„Ø¨Ù‚Ø§Ù„Ø§Øª</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©')">ğŸ› ï¸ Ø§Ù„Ø¨Ù†Ø§Ø¡</div>
                <div class="dir-pill" onclick="openFullDirectory('Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡')">âš¡ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</div>
            </div>
        </div>

        <button onclick="openPage('merchantPage')" class="merchant-btn-style">ğŸ” Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø­Ù„Ø§Øª</button>
    </div>

    <div id="merchantPage" class="full-page">
        <div class="top-nav"><button class="back-btn" onclick="closePage('merchantPage')">âœ</button><h3>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±</h3></div>
        <div id="mAuthArea" style="padding: 25px;">
            <input type="password" id="mCode" class="m-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ Ù„Ù…Ø­Ù„Ùƒ">
            <button class="m-btn" onclick="loginMerchant()">Ø¯Ø®ÙˆÙ„</button>
        </div>
        <div id="mControlArea" style="display:none; padding: 25px;">
            <div id="storeNameDisp" style="padding:15px; background:var(--primary); color:white; border-radius:15px; margin-bottom:20px; font-weight:bold; text-align:center;"></div>
            <input type="text" id="pName" class="m-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ø³Ù„Ø¹Ø©">
            <input type="text" id="pPrice" class="m-input" placeholder="Ø§Ù„Ø³Ø¹Ø±">
            <select id="pType" class="m-input"><option value="offer">ğŸ”¥ Ø¹Ø±Ø¶ ÙˆØªØ®ÙÙŠØ¶</option><option value="normal">ğŸ“¦ Ø¨Ø¶Ø§Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©</option></select>
            <button class="m-btn" onclick="addProduct()">Ù†Ø´Ø± Ø§Ù„Ø¢Ù† âœ…</button>
            <div id="mMyProds" style="margin-top:25px;"></div>
            <button onclick="logoutMerchant()" style="color:red; background:none; border:none; width:100%; margin-top:30px; cursor:pointer; font-weight:900;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>

    <div id="offersPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('offersPage')">âœ</button><h3 id="pgTitle"></h3></div><div id="offersList"></div></div>
    <div id="directoryPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('directoryPage')">âœ</button><h3 id="dirTitle"></h3></div><div id="dirStoresList"></div></div>
    <div id="storeViewPage" class="full-page"><div class="top-nav"><button class="back-btn" onclick="closePage('storeViewPage')">âœ</button><h3 id="svTitle"></h3></div><div id="svProducts"></div></div>

    <script>
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Manifest Ù„ØªØ«Ø¨ÙŠØªÙ‡ ÙƒØªØ·Ø¨ÙŠÙ‚
        const manifest = {
            "name": "Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù† Ø§Ù„Ù…ÙˆØ­Ø¯",
            "short_name": "Ø³ÙˆÙ‚ Ø¹Ø²Ø§Ù†",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#f4f7f6",
            "theme_color": "#004d40",
            "icons": [{"src": "https://cdn-icons-png.flaticon.com/512/3081/3081840.png", "sizes": "512x512", "type": "image/png", "purpose": "any maskable"}]
        };
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = URL.createObjectURL(blob); document.head.appendChild(link);

        // Firebase Setup
        const firebaseConfig = { databaseURL: "https://souq-tarim-default-rtdb.firebaseio.com/" };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙˆØª
        function playWater() { const snd = document.getElementById('waterSnd'); snd.currentTime = 0; snd.play().catch(e => {}); }
        
        function showMsg(msg, isSuccess) { 
            const t = document.getElementById('statusToast'); t.innerText = msg; 
            t.style.background = isSuccess ? "#2ecc71" : "#e74c3c"; t.style.top = "20px"; 
            playWater(); setTimeout(() => t.style.top = "-100px", 3000); 
        }

        function openPage(id) { playWater(); document.getElementById(id).style.display='block'; if(id==='merchantPage') checkAuth(); }
        function closePage(id) { playWater(); document.getElementById(id).style.display='none'; }

        // Ù†Ø¸Ø§Ù… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø£Ù… Ù„Ø§)
        function syncStatus() {
            db.ref('Stores').on('value', sSnap => {
                const stores = sSnap.val() || {};
                db.ref('Products').on('value', pSnap => {
                    const products = pSnap.val() || {};
                    const cats = ['Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©', 'Ù…Ø·Ø§Ø¹Ù… ÙˆÙƒÙØªÙŠØ±ÙŠØ§', 'Ù…ÙˆØ§Ø¯ Ø¨Ù†Ø§Ø¡ ÙˆØ³Ø¨Ø§ÙƒØ©', 'Ù…ÙˆØ§Ø¯ ÙƒÙ‡Ø±Ø¨Ø§Ø¡'];
                    cats.forEach(c => {
                        let hasOffer = false;
                        Object.keys(stores).forEach(sid => {
                            if(stores[sid].category === c && products[sid]) {
                                Object.values(products[sid]).forEach(p => { if(p.type === 'offer') hasOffer = true; });
                            }
                        });
                        const el = document.getElementById('st-'+c);
                        if(el) {
                            el.innerText = hasOffer ? "âœ… ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶" : "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶";
                            el.className = "status-tag " + (hasOffer ? "has" : "none");
                        }
                    });
                });
            });
        }
        syncStatus();

        // Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø±ÙˆØ¶
        function openGlobalOffers(cat, icon) {
            playWater();
            document.getElementById('pgTitle').innerText = icon + " Ø¹Ø±ÙˆØ¶ " + cat;
            const list = document.getElementById('offersList');
            list.innerHTML = "<p style='text-align:center; padding:20px;'>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«...</p>";
            openPage('offersPage');
            
            db.ref('Stores').once('value', sSnap => {
                const stores = sSnap.val() || {};
                db.ref('Products').once('value', pSnap => {
                    list.innerHTML = "";
                    const allP = pSnap.val() || {};
                    let found = false;
                    Object.keys(stores).forEach(sid => {
                        if(stores[sid].category === cat && allP[sid]) {
                            Object.values(allP[sid]).forEach(p => {
                                if(p.type==='offer') {
                                    found = true;
                                    list.innerHTML += `<div class="product-card"><b>${p.name}</b> <span style="float:left; color:var(--orange); font-weight:900;">${p.price}</span><br><small>ğŸª ${stores[sid].name}</small></div>`;
                                }
                            });
                        }
                    });
                    if(!found) list.innerHTML = "<p style='text-align:center; padding:50px; color:#999;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø±ÙˆØ¶ Ø­Ø§Ù„ÙŠØ§Ù‹</p>";
                });
            });
        }

        // Ù„ÙˆØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
        function loginMerchant() { 
            const codeEl = document.getElementById('mCode'); const code = codeEl.value.trim(); 
            if(!code) { codeEl.classList.add('error-shake'); setTimeout(() => codeEl.classList.remove('error-shake'), 400); return; }
            db.ref('Stores/' + code).once('value', s => { 
                if(s.exists()){ localStorage.setItem('azKey', code); localStorage.setItem('azName', s.val().name); showMerchantUI(); showMsg("ğŸ”“ ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„", true); } 
                else { codeEl.classList.add('error-shake'); showMsg("âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­", false); } 
            }); 
        }

        function addProduct() { 
            const key = localStorage.getItem('azKey'); const nEl = document.getElementById('pName'); const pEl = document.getElementById('pPrice'); 
            if(!nEl.value || !pEl.value) { showMsg("âš ï¸ Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", false); return; }
            db.ref('Products/' + key).push({ name: nEl.value, price: pEl.value, type: document.getElementById('pType').value }).then(() => { showMsg("âœ… ØªÙ… Ø§Ù„Ù†Ø´Ø±", true); nEl.value=""; pEl.value=""; }); 
        }

        function checkAuth() { if(localStorage.getItem('azKey')) showMerchantUI(); }
        function showMerchantUI() { document.getElementById('mAuthArea').style.display = 'none'; document.getElementById('mControlArea').style.display = 'block'; document.getElementById('storeNameDisp').innerText = "ğŸª Ù…ØªØ¬Ø±: " + localStorage.getItem('azName'); loadMyProducts(); }
        function loadMyProducts() { db.ref('Products/' + localStorage.getItem('azKey')).on('value', snap => { const list = document.getElementById('mMyProds'); list.innerHTML = ""; snap.forEach(p => { list.innerHTML += `<div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;"><span><b>${p.val().name}</b></span><button onclick="deleteProd('${p.key}')" style="color:red; border:none; background:none; cursor:pointer;">Ø­Ø°Ù</button></div>`; }); }); }
        function deleteProd(pid) { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø­Ø°ÙØŸ")) db.ref('Products/' + localStorage.getItem('azKey') + '/' + pid).remove(); }
        function logoutMerchant() { localStorage.clear(); location.reload(); }

        // Ø§Ù„Ø¯Ù„ÙŠÙ„ ÙˆØªØµÙØ­ Ø§Ù„Ù…Ø­Ù„Ø§Øª
        function openFullDirectory(cat) { playWater(); document.getElementById('dirTitle').innerText = "Ø¯Ù„ÙŠÙ„ " + cat; const list = document.getElementById('dirStoresList'); list.innerHTML = ""; openPage('directoryPage'); db.ref('Stores').once('value', snap => { snap.forEach(s => { if(s.val().category === cat) list.innerHTML += `<div class="product-card" onclick="viewStore('${s.key}', '${s.val().name}', '${s.val().phone}')"><b>${s.val().name}</b><br><small>ØªØµÙØ­ âœ</small></div>`; }); }); }
        function viewStore(id, name, phone) { playWater(); document.getElementById('svTitle').innerText = name; const list = document.getElementById('svProducts'); list.innerHTML = ""; openPage('storeViewPage'); db.ref('Products/' + id).once('value', snap => { snap.forEach(p => { list.innerHTML += `<div class="product-card"><b>${p.val().name}</b><br>Ø§Ù„Ø³Ø¹Ø±: ${p.val().price}</div>`; }); list.innerHTML += `<div style="text-align:center; padding:20px;"><a href="tel:${phone}" class="m-btn" style="text-decoration:none; background:#2ecc71; display:block;">ğŸ“ Ø§ØªØµÙ„ Ø¨Ø§Ù„Ù…Ø­Ù„</a></div>`; }); }
    </script>
</body>
</html>